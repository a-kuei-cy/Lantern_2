<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® å…ƒå®µç¯€é›™èªçŒœç‡ˆè¬å¤§æœƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .lantern-shadow { box-shadow: 0 0 50px rgba(255, 200, 0, 0.6); }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }
    </style>
</head>
<body class="bg-red-900 text-gray-100 min-h-screen overflow-hidden relative selection:bg-yellow-500 selection:text-red-900">

    <!-- è£é£¾ -->
    <div class="absolute top-0 left-8 w-20 h-32 bg-red-600 rounded-b-3xl opacity-90 border-t-8 border-yellow-600 z-0 flex items-center justify-center animate-bounce-slow lantern-shadow">
        <span class="text-yellow-300 text-4xl font-serif font-bold opacity-60 mt-4">æ˜¥</span>
    </div>
    <div class="absolute top-0 right-8 w-20 h-32 bg-red-600 rounded-b-3xl opacity-90 border-t-8 border-yellow-600 z-0 flex items-center justify-center animate-bounce-slow lantern-shadow" style="animation-delay: 1.5s;">
        <span class="text-yellow-300 text-4xl font-serif font-bold opacity-60 mt-4">ç¦</span>
    </div>

    <!-- App å®¹å™¨ -->
    <div id="app" class="relative z-10 container mx-auto px-4 py-4 max-w-4xl h-screen flex flex-col">
        <nav class="flex justify-between items-center mb-4 bg-black/30 p-3 rounded-2xl backdrop-blur-md border border-white/10 z-50">
            <div class="flex items-center gap-2">
                <div id="status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-600 text-gray-300 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-current animate-pulse"></span>
                    <span id="status-text">é€£ç·šä¸­...</span>
                </div>
            </div>
            <div class="flex gap-2 text-xs">
                <button onclick="router('welcome')" class="border border-white/20 px-3 py-1 rounded hover:bg-white hover:text-red-900 transition">é¦–é </button>
                <button onclick="router('dashboard')" class="border border-white/20 px-3 py-1 rounded hover:bg-white hover:text-red-900 transition">å¤§è¢å¹•</button>
                <button onclick="router('admin')" class="bg-yellow-600 text-black px-3 py-1 rounded font-bold hover:bg-yellow-500 transition">å¾Œå°</button>
            </div>
        </nav>

        <main id="view-container" class="flex-grow flex flex-col relative w-full overflow-hidden"></main>
    </div>

    <script>
        // ==========================================
        // âš™ï¸ è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
        // ==========================================
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxOiHFTrGIgUKCOhStPgFG9tq-gWO8aDaVyVoqNaMD2tFPO8U6i7nBdrGpky8Wt4wr1Eg/exec';

        // ç³»çµ±ç‹€æ…‹
        const state = {
            view: 'welcome',
            user: { class: '', name: '', score: 0, answers: [] },
            participants: [],
            riddles: [], // ç¾åœ¨å¾å¾Œç«¯è®€å–
            gameStatus: 'loading',
            timer: null,
            isAdmin: false
        };

        window.onload = () => {
            lucide.createIcons();
            router('welcome');
            fetchData();
            setInterval(fetchData, 5000);
        };

        // è®€å–è³‡æ–™ (åŒ…å«é¡Œåº«)
        async function fetchData() {
            if(!GAS_API_URL.startsWith('http')) return;
            try {
                const res = await fetch(GAS_API_URL);
                const data = await res.json();
                state.gameStatus = data.status || 'idle';
                state.participants = data.participants || [];
                // å¦‚æœå¾Œç«¯æœ‰é¡Œåº«ï¼Œå°±æ›´æ–°ï¼›å¦å‰‡ä¿ç•™ (é¿å…ç·¨è¼¯æ™‚é–ƒçˆ)
                if(data.riddles && data.riddles.length > 0) state.riddles = data.riddles;
                
                updateStatusUI();
                if (state.view === 'dashboard') renderDashboardUI();
                if (state.view === 'welcome') updateWelcomeButton();
                if (state.view === 'admin' && state.isAdmin) renderRiddleTable(); // è‹¥åœ¨å¾Œå°ï¼Œåˆ·æ–°åˆ—è¡¨
            } catch (e) {
                console.error("API Error", e);
                document.getElementById('status-text').innerText = "é›¢ç·š";
            }
        }

        function updateStatusUI() {
            const badge = document.getElementById('status-badge');
            const text = document.getElementById('status-text');
            if(!text) return;
            text.textContent = state.gameStatus.toUpperCase();
            let color = 'bg-gray-600 text-gray-300';
            if (state.gameStatus === 'active') color = 'bg-green-500 text-white shadow-[0_0_10px_#22c55e]';
            if (state.gameStatus === 'paused') color = 'bg-yellow-500 text-black';
            badge.className = `px-3 py-1 rounded-full text-xs font-bold transition-colors flex items-center gap-2 ${color}`;
        }

        function router(viewName) {
            state.view = viewName;
            const container = document.getElementById('view-container');
            container.innerHTML = '';
            if (viewName === 'welcome') renderWelcome(container);
            else if (viewName === 'game') renderGame(container);
            else if (viewName === 'result') renderResult(container);
            else if (viewName === 'dashboard') renderDashboard(container);
            else if (viewName === 'admin') renderAdmin(container);
            lucide.createIcons();
        }

        // ==========================================
        // ğŸ  æ­¡è¿é  (æ–°å¢ç­ç´šæ¬„ä½)
        // ==========================================
        function renderWelcome(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 animate-fade-in w-full overflow-y-auto">
                    <h1 class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-sm">å…ƒå®µçŒœç‡ˆè¬</h1>
                    
                    <div class="w-full max-w-md bg-red-900/60 backdrop-blur-md border border-yellow-500/30 rounded-3xl p-8 shadow-2xl">
                        
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="col-span-1">
                                <label class="block text-yellow-400 text-sm font-bold mb-1 text-left">ç­ç´š / Class</label>
                                <input type="text" id="user-class" class="w-full p-3 rounded-xl bg-black/40 border border-yellow-600/30 text-white outline-none" placeholder="ex: 101">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-yellow-400 text-sm font-bold mb-1 text-left">å§“å / Name</label>
                                <input type="text" id="user-name" class="w-full p-3 rounded-xl bg-black/40 border border-yellow-600/30 text-white outline-none" placeholder="è«‹è¼¸å…¥å§“å...">
                            </div>
                        </div>
                        
                        <button id="start-btn" onclick="startGame()" class="w-full bg-gray-600 text-gray-400 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed" disabled>
                            <i data-lucide="loader-2" class="animate-spin"></i> è¼‰å…¥ä¸­...
                        </button>
                    </div>
                </div>
            `;
            updateWelcomeButton();
        }

        function updateWelcomeButton() {
            const btn = document.getElementById('start-btn');
            if (!btn) return;
            if (state.gameStatus === 'active') {
                btn.disabled = false;
                btn.className = "w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-red-950 font-black text-xl py-4 rounded-xl shadow-lg hover:scale-105 transition cursor-pointer";
                btn.innerHTML = `<i data-lucide="play"></i> é–‹å§‹æŒ‘æˆ°`;
            } else {
                btn.disabled = true;
                btn.className = "w-full bg-gray-600 text-gray-400 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed";
                btn.innerHTML = state.gameStatus === 'idle' ? 'æ´»å‹•æº–å‚™ä¸­' : 'æ´»å‹•æš«åœ/çµæŸ';
            }
            lucide.createIcons();
        }

        function startGame() {
            const cls = document.getElementById('user-class').value.trim();
            const name = document.getElementById('user-name').value.trim();
            if (!cls || !name) return alert('è«‹å®Œæ•´è¼¸å…¥ç­ç´šèˆ‡å§“å');
            if (state.gameStatus !== 'active') return alert('æ´»å‹•å°šæœªé–‹å§‹');
            if (state.riddles.length === 0) return alert('é¡Œåº«ç‚ºç©ºï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
            
            state.user.class = cls;
            state.user.name = name;
            state.user.score = 0;
            state.user.answers = [];
            router('game');
        }

        // ==========================================
        // ğŸ® éŠæˆ²é  (è®€å–å‹•æ…‹é¡Œåº«)
        // ==========================================
        let currentQIndex = 0;
        let timeLeft = 30;

        function renderGame(container) {
            currentQIndex = 0;
            showQuestion(container);
        }

        function showQuestion(container) {
            if (currentQIndex >= state.riddles.length) {
                router('result');
                return;
            }
            const q = state.riddles[currentQIndex];
            timeLeft = 30;

            container.innerHTML = `
                <div class="max-w-md mx-auto h-full flex flex-col justify-center pb-10 w-full animate-fade-in">
                    <div class="flex justify-between items-center mb-6 bg-black/30 p-4 rounded-2xl border border-white/10">
                        <div class="flex items-center gap-2 text-yellow-400 font-mono text-2xl font-bold">
                            <i data-lucide="timer"></i> <span id="timer">${timeLeft}</span>
                        </div>
                        <div class="text-gray-400 font-mono">Q ${currentQIndex + 1} / ${state.riddles.length}</div>
                    </div>
                    <div class="bg-white text-gray-900 rounded-[2rem] p-8 shadow-2xl mb-6 flex flex-col items-center text-center border-4 border-yellow-500 relative overflow-hidden min-h-[200px] justify-center">
                        <div class="absolute top-0 left-0 h-2 bg-gray-200 w-full">
                            <div id="progress-bar" class="h-full bg-green-500 transition-all duration-1000" style="width: 100%"></div>
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-red-900">${q.cn}</h3>
                        <p class="text-gray-500 font-medium text-sm border-t border-gray-100 pt-4 w-full">${q.en}</p>
                    </div>
                    <div class="grid gap-3">
                        ${q.opts.map((opt, i) => `
                            <button onclick="handleAnswer('${opt}')" class="w-full bg-red-900/40 hover:bg-yellow-500 hover:text-red-950 border border-yellow-500/30 text-white font-bold text-lg py-4 rounded-xl transition-all shadow-md backdrop-blur-sm flex items-center justify-between px-6">
                                <span class="flex items-center gap-3"><span class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-sm">${['A','B','C','D'][i]}</span>${opt}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
            if (state.timer) clearInterval(state.timer);
            state.timer = setInterval(() => {
                timeLeft--;
                const tEl = document.getElementById('timer');
                const pEl = document.getElementById('progress-bar');
                if(tEl) tEl.innerText = timeLeft;
                if(pEl) pEl.style.width = `${(timeLeft/30)*100}%`;
                if (timeLeft <= 0) { clearInterval(state.timer); handleAnswer(null); }
            }, 1000);
        }

        window.handleAnswer = function(ans) {
            clearInterval(state.timer);
            const q = state.riddles[currentQIndex];
            if (ans === q.ans) state.user.score++;
            currentQIndex++;
            showQuestion(document.getElementById('view-container'));
        };

        // ==========================================
        // ğŸ† çµæœé  (æäº¤å«ç­ç´šè³‡æ–™)
        // ==========================================
        function renderResult(container) {
            submitScore();
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-8 animate-fade-in">
                    <i data-lucide="party-popper" class="text-yellow-400 w-24 h-24 animate-bounce"></i>
                    <div class="bg-red-900/60 backdrop-blur-md border border-yellow-500/50 p-10 rounded-3xl shadow-2xl w-full max-w-md">
                        <h2 class="text-3xl font-bold text-white mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
                        <div class="flex justify-center items-baseline gap-2 mb-8 bg-black/20 py-6 rounded-2xl my-6">
                            <span class="text-7xl font-black text-yellow-400">${state.user.score}</span>
                            <span class="text-xl text-gray-500">/ ${state.riddles.length}</span>
                        </div>
                        <button onclick="router('dashboard')" class="w-full bg-white text-red-900 font-bold py-4 rounded-xl hover:bg-gray-100 shadow-lg flex items-center justify-center gap-2">
                            <i data-lucide="bar-chart-3"></i> æŸ¥çœ‹å¤§è¢å¹•
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function submitScore() {
            const time = Math.floor(Math.random() * 100) + 100;
            fetch(GAS_API_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'submit_score',
                    class: state.user.class,
                    name: state.user.name,
                    score: state.user.score,
                    time: time
                })
            });
        }

        // ==========================================
        // âš™ï¸ å¾Œå° (é¡Œç›®ç®¡ç† + åŒ¯å‡ºåŠŸèƒ½)
        // ==========================================
        function renderAdmin(container) {
            // æœªç™»å…¥ç‹€æ…‹
            if (!state.isAdmin) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xs text-gray-800">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-900"><i data-lucide="lock"></i> ç®¡ç†è€…ç™»å…¥</h2>
                            <input type="password" id="admin-pwd" class="w-full border p-2 rounded mb-4 text-black" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                            <button onclick="adminLogin()" class="w-full bg-red-800 text-white py-2 rounded font-bold">ç™»å…¥</button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // å·²ç™»å…¥ç‹€æ…‹
            container.innerHTML = `
                <div class="bg-white text-gray-800 p-6 rounded-3xl h-full shadow-xl flex flex-col overflow-hidden">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b">
                        <h2 class="text-xl font-bold text-red-900 flex items-center gap-2"><i data-lucide="settings"></i> ç®¡ç†ä¸­æ§å°</h2>
                        <button onclick="state.isAdmin=false;router('admin')" class="text-xs bg-gray-200 px-3 py-1 rounded">ç™»å‡º</button>
                    </div>

                    <div class="flex-grow overflow-y-auto pr-2 space-y-8">
                        <!-- 1. ç‹€æ…‹æ§åˆ¶ -->
                        <section>
                            <h3 class="font-bold text-gray-600 mb-2 flex gap-2"><i data-lucide="toggle-left"></i> æ´»å‹•ç‹€æ…‹</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="updateStatus('idle')" class="p-3 rounded-lg border-2 border-yellow-200 bg-yellow-50 text-yellow-800 font-bold">æº–å‚™ä¸­</button>
                                <button onclick="updateStatus('active')" class="p-3 rounded-lg border-2 border-green-200 bg-green-50 text-green-800 font-bold">é€²è¡Œä¸­</button>
                                <button onclick="updateStatus('ended')" class="p-3 rounded-lg border-2 border-red-200 bg-red-50 text-red-800 font-bold">å·²çµæŸ</button>
                            </div>
                        </section>

                        <!-- 2. åŒ¯å‡ºæ•¸æ“š (æ–°åŠŸèƒ½) -->
                        <section>
                            <h3 class="font-bold text-gray-600 mb-2 flex gap-2"><i data-lucide="download"></i> æ•¸æ“šåŒ¯å‡º</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="exportLeaderboard()" class="bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <i data-lucide="file-spreadsheet"></i> åŒ¯å‡ºæ’è¡Œæ¦œ
                                </button>
                                <button onclick="exportWinners()" class="bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 flex items-center justify-center gap-2">
                                    <i data-lucide="gift"></i> åŒ¯å‡ºæŠ½çåå–®
                                </button>
                            </div>
                            <button onclick="clearData()" class="mt-2 w-full border border-red-200 text-red-600 py-2 rounded-xl text-sm hover:bg-red-50">æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
                        </section>

                        <!-- 3. é¡Œç›®ç®¡ç† (æ–°åŠŸèƒ½) -->
                        <section>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-gray-600 flex gap-2"><i data-lucide="book-open"></i> é¡Œåº«ç®¡ç† (${state.riddles.length}é¡Œ)</h3>
                                <button onclick="addRiddle()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">+ æ–°å¢é¡Œç›®</button>
                            </div>
                            <div class="bg-gray-100 rounded-xl p-2 h-64 overflow-y-auto text-sm" id="riddle-list">
                                <!-- é¡Œç›®åˆ—è¡¨ -->
                            </div>
                            <p class="text-xs text-gray-400 mt-1">* ç·¨è¼¯å¾Œè«‹é‡æ–°æ•´ç†é é¢</p>
                        </section>
                    </div>
                </div>
            `;
            renderRiddleTable();
            lucide.createIcons();
        }

        window.adminLogin = function() {
            const p = document.getElementById('admin-pwd').value;
            if(p === 'admin') { state.isAdmin = true; router('admin'); } 
            else alert('å¯†ç¢¼éŒ¯èª¤');
        }

        // é¡Œç›®ç®¡ç†é‚è¼¯
        function renderRiddleTable() {
            const list = document.getElementById('riddle-list');
            if(!list) return;
            list.innerHTML = state.riddles.map((r, i) => `
                <div class="bg-white p-3 rounded-lg mb-2 shadow-sm border border-gray-200">
                    <div class="flex justify-between font-bold text-red-900 mb-1">
                        <span>Q${i+1}. ${r.cn}</span>
                        <button onclick="deleteRiddle(${i})" class="text-red-500 hover:bg-red-50 px-2 rounded">åˆªé™¤</button>
                    </div>
                    <div class="text-gray-500 text-xs mb-2">${r.en}</div>
                    <div class="grid grid-cols-4 gap-1 text-xs text-center text-gray-600">
                        ${r.opts.map(o => `<span class="${o===r.ans?'bg-green-100 text-green-700 font-bold border-green-200':''} border rounded py-1">${o}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.addRiddle = function() {
            const cn = prompt("ä¸­æ–‡é¡Œç›®:"); if(!cn) return;
            const en = prompt("è‹±æ–‡é¡Œç›® (å¯ç•™ç©º):") || " ";
            const ans = prompt("æ­£ç¢ºç­”æ¡ˆ:");
            const optsStr = prompt("å››å€‹é¸é … (ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚: A,B,C,D):");
            if(!ans || !optsStr) return alert("è³‡æ–™ä¸å®Œæ•´");
            
            const opts = optsStr.split(/[,ï¼Œ]/).map(s=>s.trim());
            if(opts.length !== 4) return alert("è«‹è¼¸å…¥å‰›å¥½ 4 å€‹é¸é …");
            if(!opts.includes(ans)) return alert("é¸é …ä¸­å¿…é ˆåŒ…å«æ­£ç¢ºç­”æ¡ˆ");

            // å…ˆæ›´æ–°æœ¬åœ°
            state.riddles.push({ id: Date.now(), cn, en, ans, opts });
            renderRiddleTable();
            
            // åŒæ­¥åˆ°å¾Œç«¯
            saveRiddlesToBackend();
        }

        window.deleteRiddle = function(index) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¡Œï¼Ÿ")) return;
            state.riddles.splice(index, 1);
            renderRiddleTable();
            saveRiddlesToBackend();
        }

        function saveRiddlesToBackend() {
            // ç‚ºäº†ç°¡åŒ–ï¼Œé€™è£¡å°‡æ‰€æœ‰é¡Œç›®è½‰æ›æˆäºŒç¶­é™£åˆ—ä¸€æ¬¡å›å¯« (ID, CN, EN, Ans, Opt1...)
            const tableData = state.riddles.map((r, idx) => [
                idx + 1, r.cn, r.en, r.ans, r.opts[0], r.opts[1], r.opts[2], r.opts[3]
            ]);

            fetch(GAS_API_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'manage_riddle',
                    method: 'delete', // é€™è£¡ç”¨ delete é‚è¼¯å…¶å¯¦æ˜¯ã€Œè¦†è“‹ã€
                    allRiddles: tableData,
                    password: 'admin'
                })
            });
        }

        // åŒ¯å‡ºåŠŸèƒ½
        window.exportLeaderboard = function() {
            let csv = "\uFEFFClass,Name,Score,Time\n"; // \uFEFF è§£æ±ºä¸­æ–‡äº‚ç¢¼
            const sorted = [...state.participants].sort((a,b) => b.score - a.score || a.time - b.time);
            sorted.forEach(p => { csv += `${p.class},${p.name},${p.score},${p.time}\n` });
            downloadCSV(csv, 'Leaderboard.csv');
        }

        window.exportWinners = function() {
            // é€™è£¡é‚è¼¯å‡è¨­ï¼šåˆ†æ•¸å¤§æ–¼ç­‰æ–¼ç¸½é¡Œæ•¸ä¸€åŠè€…å¯æŠ½ç (å¯è‡ªè¡Œä¿®æ”¹è¦å‰‡)
            const threshold = Math.ceil(state.riddles.length / 2);
            let csv = "\uFEFFClass,Name,Score\n";
            const winners = state.participants.filter(p => p.score >= threshold);
            winners.forEach(p => { csv += `${p.class},${p.name},${p.score}\n` });
            downloadCSV(csv, 'LuckyDraw_List.csv');
        }

        function downloadCSV(content, fileName) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
        }

        // å…¶ä»–å¾Œå°åŠŸèƒ½
        window.updateStatus = function(s) {
            fetch(GAS_API_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'update_status', status: s, password: 'admin' })
            });
            state.gameStatus = s; // æœ¬åœ°å…ˆæ›´æ–°
            alert("ç‹€æ…‹å·²åˆ‡æ›");
        }
        window.clearData = function() {
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç©å®¶æ•¸æ“šï¼Ÿ(ä¸å¯å¾©åŸ)")) {
                fetch(GAS_API_URL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'clear_data', password: 'admin' })
                });
                state.participants = [];
                alert("å·²ç™¼é€æ¸…ç©ºæŒ‡ä»¤");
            }
        }

        // Dashboard ä¿æŒä¸è®Š (çœç•¥ç¨‹å¼ç¢¼ä»¥ç¯€çœç©ºé–“ï¼Œè«‹ç›´æ¥ç”¨å‰ä¸€ç‰ˆé‚è¼¯å³å¯)
        function renderDashboard(container) {
             container.innerHTML = `
                <div class="h-full flex flex-col gap-4 animate-fade-in">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-yellow-500/20 p-4 rounded-xl flex items-center gap-3">
                            <div class="text-2xl font-bold font-mono text-white">${state.participants.length}</div>
                            <div class="text-xs text-yellow-200/60 uppercase">äººåƒåŠ </div>
                        </div>
                    </div>
                    <div class="flex-grow flex flex-col lg:flex-row gap-6 h-full overflow-hidden">
                        <div class="w-full lg:w-1/3 bg-black/20 rounded-2xl p-4 flex flex-col border border-white/5 backdrop-blur-sm">
                            <h3 class="font-bold text-yellow-200 mb-4">è‹±é›„æ¦œ (Top 10)</h3>
                            <div id="leaderboard-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                        </div>
                        <div class="w-full lg:w-2/3 bg-red-900/40 border border-yellow-500/30 rounded-2xl p-6 flex flex-col items-center justify-center relative">
                             <h2 class="text-4xl font-black text-yellow-400 mb-8">LUCKY DRAW</h2>
                             <div class="text-6xl font-black text-white mb-8" id="winner-display">?</div>
                             <button onclick="toggleDraw()" class="px-8 py-3 bg-yellow-500 text-red-900 font-bold rounded-full">é–‹å§‹æŠ½ç</button>
                        </div>
                    </div>
                </div>
            `;
            renderDashboardUI();
        }
        function renderDashboardUI() {
            const list = document.getElementById('leaderboard-list');
            if(!list) return;
            const sorted = [...state.participants].sort((a, b) => b.score - a.score);
            list.innerHTML = sorted.slice(0, 10).map((p, i) => `
                <div class="flex items-center bg-white/5 p-2 rounded-lg text-sm">
                    <div class="w-6 h-6 rounded-full bg-yellow-500 text-red-900 flex items-center justify-center font-bold mr-3 text-xs">${i+1}</div>
                    <div class="flex-grow text-gray-200">${p.class} ${p.name}</div>
                    <div class="text-yellow-400 font-bold">${p.score}</div>
                </div>
            `).join('');
        }
        let isRolling = false, drawInterval;
        window.toggleDraw = function() {
            const display = document.getElementById('winner-display');
            if(!state.participants.length) return alert('ç„¡äººåƒåŠ ');
            if(!isRolling) {
                isRolling = true;
                drawInterval = setInterval(() => {
                    const r = state.participants[Math.floor(Math.random()*state.participants.length)];
                    display.innerText = `${r.class} ${r.name}`;
                }, 50);
            } else {
                isRolling = false;
                clearInterval(drawInterval);
                display.classList.add('scale-125','text-yellow-300');
            }
        }
    </script>
</body>
</html>
