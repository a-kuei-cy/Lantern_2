<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® å…ƒå®µç¯€é›™èªçŒœç‡ˆè¬å¤§æœƒ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        .lantern-shadow { box-shadow: 0 0 50px rgba(255, 200, 0, 0.6); }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
    </style>
</head>
<body class="bg-red-900 text-gray-100 min-h-screen overflow-hidden relative selection:bg-yellow-500 selection:text-red-900">

    <!-- èƒŒæ™¯è£é£¾ -->
    <div class="absolute top-0 left-8 w-20 h-32 bg-red-600 rounded-b-3xl opacity-90 border-t-8 border-yellow-600 z-0 flex items-center justify-center animate-bounce-slow lantern-shadow">
        <span class="text-yellow-300 text-4xl font-serif font-bold opacity-60 mt-4">æ˜¥</span>
    </div>
    <div class="absolute top-0 right-8 w-20 h-32 bg-red-600 rounded-b-3xl opacity-90 border-t-8 border-yellow-600 z-0 flex items-center justify-center animate-bounce-slow lantern-shadow" style="animation-delay: 1.5s;">
        <span class="text-yellow-300 text-4xl font-serif font-bold opacity-60 mt-4">ç¦</span>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="relative z-10 container mx-auto px-4 py-4 max-w-4xl h-screen flex flex-col">
        <!-- å°èˆªåˆ— -->
        <nav class="flex justify-between items-center mb-4 bg-black/30 p-3 rounded-2xl backdrop-blur-md border border-white/10 z-50">
            <div class="flex items-center gap-2">
                <div id="status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-600 text-gray-300 transition-colors flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-current animate-pulse"></span>
                    <span id="status-text">é€£ç·šä¸­...</span>
                </div>
            </div>
            <div class="flex gap-2 text-xs">
                <button onclick="router('welcome')" class="border border-white/20 px-3 py-1 rounded hover:bg-white hover:text-red-900 transition">ç©å®¶ Player</button>
                <button onclick="router('dashboard')" class="border border-white/20 px-3 py-1 rounded hover:bg-white hover:text-red-900 transition">å¤§è¢å¹• Screen</button>
                <button onclick="router('admin')" class="bg-yellow-600 text-black px-3 py-1 rounded font-bold hover:bg-yellow-500 transition">å¾Œå° Admin</button>
            </div>
        </nav>

        <!-- å…§å®¹æ¸²æŸ“å€ -->
        <main id="view-container" class="flex-grow flex flex-col relative w-full"></main>
    </div>

    <script>
        // ==========================================
        // âš™ï¸ è¨­å®šå€ (å·²å¡«å…¥æ‚¨çš„ç¶²å€)
        // ==========================================
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxOiHFTrGIgUKCOhStPgFG9tq-gWO8aDaVyVoqNaMD2tFPO8U6i7nBdrGpky8Wt4wr1Eg/exec'; 

        // ==========================================
        // ğŸ“š é¡Œåº« (30é¡Œç¯„ä¾‹)
        // ==========================================
        const RIDDLES = [
            { id: 1, cn: "åäº”å¤© (æ‰“ä¸€å­—)", en: "Fifteen days (Guess a character)", ans: "èƒ–", opts: ["èƒ–", "è…«", "èƒƒ", "æœ‹"] },
            { id: 2, cn: "ç´…é—œå…¬ï¼Œç™½åŠ‰å‚™ï¼Œé»‘å¼µé£›ï¼Œä¸‰çµç¾©ã€‚(æ‰“ä¸€æ°´æœ)", en: "Red outside, white inside, black seeds.", ans: "è¥¿ç“œ", opts: ["è¥¿ç“œ", "ç«é¾æœ", "è˜‹æœ", "å±±ç«¹"] },
            { id: 3, cn: "åå­—å«ç‰›ä¸æ˜¯ç‰›ï¼Œä¸æœƒæ‹‰è»Šåªæœƒæ¸¸ã€‚(æ‰“ä¸€å‹•ç‰©)", en: "Named 'cow' but works in water.", ans: "è¸ç‰›", opts: ["æ°´ç‰›", "è¸ç‰›", "æµ·ç‰›", "çŠ€ç‰›"] },
            { id: 4, cn: "ç™½ç™½èº«å­åœ“åˆåœ“ï¼Œæ‰é€²æµ·è£¡æ¸¸ä¸€åœˆã€‚(æ‰“ä¸€ç¯€æ…¶é£Ÿç‰©)", en: "White and round body, swims in soup.", ans: "æ¹¯åœ“", opts: ["æ°´é¤ƒ", "æ¹¯åœ“", "é¥…é ­", "é­šä¸¸"] },
            { id: 5, cn: "ä¸€åŠ ä¸€ä¸æ˜¯äºŒã€‚(æ‰“ä¸€å­—)", en: "One plus one is not two.", ans: "ç‹", opts: ["ç‹", "ä¸°", "ä¸‰", "åœŸ"] },
            { id: 6, cn: "åƒæ¢ç·šï¼Œè¬æ¢ç·šï¼Œæ‰åœ¨æ°´è£¡çœ‹ä¸è¦‹ã€‚(æ‰“ä¸€è‡ªç„¶ç¾è±¡)", en: "Thousands of threads vanish in water.", ans: "é›¨", opts: ["é›ª", "é›¨", "é¢¨", "éœ§"] },
            { id: 7, cn: "æœ‰é¢¨ä¸å‹•ç„¡é¢¨å‹•ï¼Œä¸å‹•ç„¡é¢¨å‹•æœ‰é¢¨ã€‚(æ‰“ä¸€ç”¨å“)", en: "Moves when no wind, creates wind moving.", ans: "æ‰‡å­", opts: ["é¢¨è»Š", "æ‰‡å­", "æ——å­", "é¢¨éˆ´"] },
            { id: 8, cn: "è€³æœµé•·ï¼Œå°¾å·´çŸ­ï¼Œç´…çœ¼ç›ï¼Œç™½æ¯›è¡«ã€‚(æ‰“ä¸€å‹•ç‰©)", en: "Long ears, red eyes.", ans: "å…”å­", opts: ["è€é¼ ", "å…”å­", "è²“å’ª", "ç¾Š"] },
            { id: 9, cn: "å››å››æ–¹æ–¹ä¸€åº§åŸï¼Œè£¡é¢ä½è‘—å¤§å…µä¸ã€‚(æ‰“ä¸€é›»å™¨)", en: "Square city with soldiers inside.", ans: "é›»è¦–", opts: ["å†°ç®±", "é›»è¦–", "çƒ¤ç®±", "å¾®æ³¢çˆ"] },
            { id: 10, cn: "å…©å…„å¼Ÿï¼Œæ‰‹æ‹‰æ‰‹ï¼Œä¸€å€‹è½‰ï¼Œä¸€å€‹èµ°ã€‚(æ‰“ä¸€æ–‡å…·)", en: "Two brothers, one turns, one walks.", ans: "åœ“è¦", opts: ["åœ“è¦", "å‰ªåˆ€", "å°º", "é‰›ç­†"] }
            // å¯ç¹¼çºŒæ“´å……è‡³30é¡Œ...
        ];

        // ==========================================
        // ğŸ§  ç³»çµ±ç‹€æ…‹
        // ==========================================
        const state = {
            view: 'welcome',
            user: { name: '', score: 0, answers: [] },
            participants: [],
            gameStatus: 'loading', // idle, active, ended, loading
            timer: null
        };

        // åˆå§‹åŒ–
        window.onload = () => {
            lucide.createIcons();
            router('welcome');
            fetchData(); // åˆå§‹æ‹‰å–
            setInterval(fetchData, 5000); // è¼ªè©¢å¾Œç«¯
        };

        // æ•¸æ“šåŒæ­¥
        async function fetchData() {
            try {
                const res = await fetch(GAS_API_URL);
                const data = await res.json();
                
                // æ›´æ–°ç‹€æ…‹
                state.gameStatus = data.status || 'idle';
                state.participants = data.participants || [];
                
                updateStatusUI();
                
                // å¦‚æœåœ¨å¤§è¢å¹•é é¢ï¼Œåˆ·æ–°æ’è¡Œæ¦œ
                if (state.view === 'dashboard') renderDashboardUI();
                
                // å¦‚æœåœ¨æ­¡è¿é ï¼Œåˆ·æ–°é–‹å§‹æŒ‰éˆ•
                if (state.view === 'welcome') updateWelcomeButton();

            } catch (e) {
                console.error("API Error:", e);
                document.getElementById('status-text').innerText = "é€£ç·šå¤±æ•— OFF";
                document.getElementById('status-badge').classList.add('bg-red-600');
            }
        }

        function updateStatusUI() {
            const badge = document.getElementById('status-badge');
            const text = document.getElementById('status-text');
            if(!text || !badge) return;

            text.textContent = state.gameStatus.toUpperCase();
            
            let colorClass = 'bg-gray-600 text-gray-300';
            if (state.gameStatus === 'active') colorClass = 'bg-green-500 text-white shadow-[0_0_10px_#22c55e]';
            if (state.gameStatus === 'paused') colorClass = 'bg-yellow-500 text-black';
            if (state.gameStatus === 'ended') colorClass = 'bg-red-600 text-white';

            badge.className = `px-3 py-1 rounded-full text-xs font-bold transition-colors flex items-center gap-2 ${colorClass}`;
        }

        // è·¯ç”±æ§åˆ¶
        function router(viewName) {
            state.view = viewName;
            const container = document.getElementById('view-container');
            container.innerHTML = ''; // æ¸…ç©º

            if (viewName === 'welcome') renderWelcome(container);
            else if (viewName === 'game') renderGame(container);
            else if (viewName === 'result') renderResult(container);
            else if (viewName === 'dashboard') renderDashboard(container);
            else if (viewName === 'admin') renderAdmin(container);

            lucide.createIcons();
        }

        // ==========================================
        // ğŸ“± è¦–åœ–ï¼šæ­¡è¿é  (Welcome)
        // ==========================================
        function renderWelcome(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 animate-fade-in w-full">
                    <div class="space-y-2">
                        <h1 class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-sm">å…ƒå®µçŒœç‡ˆè¬</h1>
                        <h2 class="text-xl text-yellow-200/80 font-light tracking-widest">LANTERN FESTIVAL</h2>
                    </div>
                    
                    <div class="w-full max-w-md bg-red-900/60 backdrop-blur-md border border-yellow-500/30 rounded-3xl p-8 shadow-2xl relative">
                        <label class="block text-yellow-400 text-sm font-bold mb-2 text-left">åƒè³½è€…å§“å / Name</label>
                        <input type="text" id="username" class="w-full p-4 rounded-xl bg-black/40 border border-yellow-600/30 text-white focus:ring-2 focus:ring-yellow-500 outline-none mb-6 text-lg placeholder-white/20" placeholder="è«‹è¼¸å…¥å§“å..." onkeydown="if(event.key==='Enter') startGame()">
                        
                        <button id="start-btn" onclick="startGame()" class="w-full bg-gray-600 text-gray-400 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed transition-all" disabled>
                            <i data-lucide="loader-2" class="animate-spin"></i> è¼‰å…¥ä¸­...
                        </button>
                        
                        <div class="mt-4 text-xs text-yellow-200/50">
                            * éœ€ç­‰å¾…ä¸»æŒäººé–‹å•Ÿæ´»å‹•ç‹€æ…‹
                        </div>
                    </div>
                </div>
            `;
            updateWelcomeButton();
        }

        function updateWelcomeButton() {
            const btn = document.getElementById('start-btn');
            if (!btn) return;

            if (state.gameStatus === 'active') {
                btn.disabled = false;
                btn.className = "w-full bg-gradient-to-r from-yellow-600 to-yellow-500 text-red-950 font-black text-xl py-4 rounded-xl shadow-lg hover:scale-105 flex items-center justify-center gap-2 cursor-pointer transition-all";
                btn.innerHTML = `<i data-lucide="play"></i> é–‹å§‹æŒ‘æˆ° START`;
            } else if (state.gameStatus === 'idle') {
                btn.disabled = true;
                btn.className = "w-full bg-gray-600 text-gray-400 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed";
                btn.innerHTML = `<i data-lucide="lock"></i> æ´»å‹•æº–å‚™ä¸­`;
            } else if (state.gameStatus === 'paused') {
                btn.disabled = true;
                btn.className = "w-full bg-yellow-600/50 text-yellow-200 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed";
                btn.innerHTML = `<i data-lucide="pause-circle"></i> æ´»å‹•æš«åœä¸­`;
            } else {
                btn.disabled = true;
                btn.className = "w-full bg-red-800 text-red-300 font-bold text-xl py-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed";
                btn.innerHTML = `<i data-lucide="x-circle"></i> æ´»å‹•å·²çµæŸ`;
            }
            lucide.createIcons();
        }

        function startGame() {
            const name = document.getElementById('username').value.trim();
            if (!name) return alert('è«‹è¼¸å…¥å§“å');
            if (state.gameStatus !== 'active') return alert('æ´»å‹•å°šæœªé–‹æ”¾');
            
            state.user.name = name;
            state.user.score = 0;
            state.user.answers = [];
            router('game');
        }

        // ==========================================
        // ğŸ® è¦–åœ–ï¼šéŠæˆ²é  (Game)
        // ==========================================
        let currentQIndex = 0;
        let timeLeft = 30;

        function renderGame(container) {
            currentQIndex = 0;
            showQuestion(container);
        }

        function showQuestion(container) {
            if (currentQIndex >= RIDDLES.length) {
                router('result');
                return;
            }

            const q = RIDDLES[currentQIndex];
            timeLeft = 30;

            container.innerHTML = `
                <div class="max-w-md mx-auto h-full flex flex-col justify-center pb-10 w-full animate-fade-in">
                    <div class="flex justify-between items-center mb-6 bg-black/30 p-4 rounded-2xl border border-white/10">
                        <div class="flex items-center gap-2 text-yellow-400 font-mono text-2xl font-bold">
                            <i data-lucide="timer"></i> <span id="timer">${timeLeft}</span>
                        </div>
                        <div class="text-gray-400 font-mono">Q ${currentQIndex + 1} / ${RIDDLES.length}</div>
                    </div>

                    <div class="bg-white text-gray-900 rounded-[2rem] p-8 shadow-2xl mb-6 flex flex-col items-center text-center border-4 border-yellow-500 relative overflow-hidden min-h-[220px] justify-center">
                        <div class="absolute top-0 left-0 h-2 bg-gray-200 w-full">
                            <div id="progress-bar" class="h-full bg-green-500 transition-all duration-1000" style="width: 100%"></div>
                        </div>
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 text-red-900">${q.cn}</h3>
                        <p class="text-gray-500 font-medium text-sm border-t border-gray-100 pt-4 w-full">${q.en}</p>
                    </div>

                    <div class="grid gap-3" id="options-container">
                        ${q.opts.map((opt, i) => `
                            <button onclick="handleAnswer('${opt}')" class="w-full bg-red-900/40 hover:bg-yellow-500 hover:text-red-950 border border-yellow-500/30 text-white font-bold text-lg py-4 rounded-xl transition-all shadow-md backdrop-blur-sm flex items-center justify-between px-6 group">
                                <span class="flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-sm">${['A','B','C','D'][i]}</span>
                                    ${opt}
                                </span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();

            // è¨ˆæ™‚å™¨é‚è¼¯
            if (state.timer) clearInterval(state.timer);
            state.timer = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById('timer');
                const progressEl = document.getElementById('progress-bar');
                
                if(timerEl) timerEl.innerText = timeLeft;
                if(progressEl) progressEl.style.width = `${(timeLeft/30)*100}%`;
                
                if (timeLeft <= 0) {
                    clearInterval(state.timer);
                    handleAnswer(null); // è¶…æ™‚
                }
            }, 1000);
        }

        window.handleAnswer = function(ans) {
            clearInterval(state.timer);
            const q = RIDDLES[currentQIndex];
            if (ans === q.ans) state.user.score++;
            
            state.user.answers.push({ id: q.id, ans: ans, correct: ans === q.ans });
            currentQIndex++;
            showQuestion(document.getElementById('view-container'));
        };

        // ==========================================
        // ğŸ† è¦–åœ–ï¼šçµæœé  (Result)
        // ==========================================
        function renderResult(container) {
            submitScore();

            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-8 animate-fade-in">
                    <div class="relative">
                        <i data-lucide="party-popper" class="text-yellow-400 w-24 h-24 animate-bounce relative z-10"></i>
                        <div class="absolute inset-0 bg-yellow-400 blur-xl opacity-30 animate-pulse"></div>
                    </div>
                    
                    <div class="bg-red-900/60 backdrop-blur-md border border-yellow-500/50 p-10 rounded-3xl shadow-2xl w-full max-w-md">
                        <h2 class="text-3xl font-bold text-white mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
                        <div class="flex justify-center items-baseline gap-2 mb-8 bg-black/20 py-6 rounded-2xl my-6 border border-white/5">
                            <span class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600">${state.user.score}</span>
                            <span class="text-xl text-gray-500 font-bold">/ ${RIDDLES.length}</span>
                        </div>
                        <p class="text-green-400 text-sm mb-6 flex items-center justify-center gap-2 bg-green-500/10 py-2 rounded-lg">
                            <i data-lucide="check-circle" size="16"></i> æˆç¸¾å·²ä¸Šå‚³
                        </p>
                        <button onclick="router('dashboard')" class="w-full bg-white text-red-900 font-bold py-4 rounded-xl hover:bg-gray-100 shadow-lg flex items-center justify-center gap-2">
                            <i data-lucide="bar-chart-3"></i> æŸ¥çœ‹å¤§è¢å¹• Dashboard
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function submitScore() {
            const totalTime = Math.floor(Math.random() * 100) + 100; // æ¨¡æ“¬æ™‚é–“
            // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€è³‡æ–™åˆ° GAS
            fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' }, // GAS æ¥æ”¶ text/plain è¼ƒç©©å®š
                body: JSON.stringify({
                    action: 'submit_score',
                    name: state.user.name,
                    score: state.user.score,
                    time: totalTime
                })
            }).catch(e => console.error(e));
        }

        // ==========================================
        // ğŸ“Š è¦–åœ–ï¼šå¤§è¢å¹• (Dashboard)
        // ==========================================
        let isRolling = false;
        let drawInterval;

        function renderDashboard(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col gap-4 animate-fade-in">
                    <!-- é ‚éƒ¨æ•¸æ“šå¡ -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-yellow-500/20 border border-yellow-500/30 p-4 rounded-xl flex items-center gap-3">
                            <div class="p-2 bg-yellow-500/20 rounded-lg"><i data-lucide="users" class="text-yellow-400 w-6 h-6"></i></div>
                            <div>
                                <div class="text-2xl font-bold font-mono" id="db-count">0</div>
                                <div class="text-xs text-yellow-200/60 uppercase">åƒè³½äººæ•¸</div>
                            </div>
                        </div>
                         <div class="bg-blue-500/20 border border-blue-500/30 p-4 rounded-xl flex items-center gap-3">
                            <div class="p-2 bg-blue-500/20 rounded-lg"><i data-lucide="activity" class="text-blue-400 w-6 h-6"></i></div>
                            <div>
                                <div class="text-2xl font-bold font-mono" id="db-status">IDLE</div>
                                <div class="text-xs text-blue-200/60 uppercase">æ´»å‹•ç‹€æ…‹</div>
                            </div>
                        </div>
                         <div class="hidden md:flex bg-green-500/20 border border-green-500/30 p-4 rounded-xl items-center gap-3">
                            <div class="p-2 bg-green-500/20 rounded-lg"><i data-lucide="trophy" class="text-green-400 w-6 h-6"></i></div>
                            <div>
                                <div class="text-2xl font-bold font-mono" id="db-top">0</div>
                                <div class="text-xs text-green-200/60 uppercase">æœ€é«˜åˆ†</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow flex flex-col lg:flex-row gap-6 h-full overflow-hidden">
                        <!-- å·¦å´ï¼šæ’è¡Œæ¦œ -->
                        <div class="w-full lg:w-1/3 bg-black/20 rounded-2xl p-4 flex flex-col border border-white/5 backdrop-blur-sm">
                            <h3 class="text-xl font-bold text-yellow-200 mb-4 flex items-center gap-2 border-b border-white/5 pb-2">
                                <i data-lucide="crown" class="text-yellow-400"></i> è‹±é›„æ¦œ (Top 10)
                            </h3>
                            <div id="leaderboard-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                                <div class="text-center text-gray-500 mt-10">è¼‰å…¥æ•¸æ“šä¸­...</div>
                            </div>
                        </div>

                        <!-- å³å´ï¼šæŠ½çå€ -->
                        <div class="w-full lg:w-2/3 bg-gradient-to-br from-red-900 to-red-950 border border-yellow-500/30 rounded-2xl p-6 flex flex-col items-center justify-center relative shadow-2xl overflow-hidden">
                             <!-- è£é£¾èƒŒæ™¯ -->
                             <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                             
                             <h2 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500 tracking-widest uppercase mb-8 drop-shadow-sm">LUCKY DRAW</h2>
                             
                             <div class="w-full max-w-md h-48 bg-black/40 rounded-3xl border-2 border-yellow-500/30 flex items-center justify-center mb-8 backdrop-blur-md relative overflow-hidden shadow-inner">
                                 <div id="winner-display" class="text-5xl md:text-6xl font-black text-yellow-100 text-center">?</div>
                             </div>

                             <button id="draw-btn" onclick="toggleDraw()" class="px-10 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-red-900 text-2xl font-black rounded-full shadow-lg hover:scale-105 hover:shadow-yellow-500/50 transition flex items-center gap-2 border-2 border-yellow-400">
                                 <i data-lucide="sparkles"></i> é–‹å§‹æŠ½ç
                             </button>
                        </div>
                    </div>
                </div>
            `;
            renderDashboardUI();
            lucide.createIcons();
        }

        function renderDashboardUI() {
            const countEl = document.getElementById('db-count');
            const statusEl = document.getElementById('db-status');
            const topEl = document.getElementById('db-top');
            
            if(countEl) countEl.innerText = state.participants.length;
            if(statusEl) statusEl.innerText = state.gameStatus.toUpperCase();
            
            // æ’åºèˆ‡æ¸²æŸ“
            const list = document.getElementById('leaderboard-list');
            if (!list) return;

            const sorted = [...state.participants].sort((a, b) => b.score - a.score || a.time - b.time).slice(0, 10);
            if(topEl && sorted.length > 0) topEl.innerText = sorted[0].score;

            if (sorted.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-500 mt-10">ç­‰å¾…åƒè³½è€…...</div>`;
            } else {
                list.innerHTML = sorted.map((p, i) => `
                    <div class="flex items-center bg-white/5 p-3 rounded-xl border border-white/5 hover:bg-white/10 transition">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3 ${i===0?'bg-yellow-400 text-red-900 shadow-lg': i===1?'bg-gray-400 text-gray-900': i===2?'bg-orange-700 text-orange-200':'bg-gray-800 text-gray-500'}">${i+1}</div>
                        <div class="flex-grow truncate font-bold text-gray-200 text-lg">${p.name}</div>
                        <div class="text-yellow-400 font-bold font-mono text-xl">${p.score}</div>
                    </div>
                `).join('');
            }
        }

        window.toggleDraw = function() {
            const display = document.getElementById('winner-display');
            const btn = document.getElementById('draw-btn');
            
            if (state.participants.length === 0) return alert('ç›®å‰æ²’æœ‰åƒè³½è€…æ•¸æ“š');

            if (!isRolling) {
                isRolling = true;
                btn.innerHTML = `<i data-lucide="stop-circle"></i> åœæ­¢ STOP`;
                btn.className = "px-10 py-4 bg-red-600 text-white text-2xl font-black rounded-full shadow-lg hover:scale-105 transition flex items-center gap-2 border-2 border-red-400";
                
                drawInterval = setInterval(() => {
                    const rand = state.participants[Math.floor(Math.random() * state.participants.length)];
                    display.innerText = rand.name;
                    display.className = "text-5xl md:text-6xl font-black text-gray-400 text-center blur-[2px]";
                }, 50);
            } else {
                isRolling = false;
                clearInterval(drawInterval);
                btn.innerHTML = `<i data-lucide="sparkles"></i> å†æ¬¡æŠ½ç`;
                btn.className = "px-10 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-red-900 text-2xl font-black rounded-full shadow-lg hover:scale-105 hover:shadow-yellow-500/50 transition flex items-center gap-2 border-2 border-yellow-400";
                
                display.className = "text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-500 text-center scale-110 transition-transform duration-300";
            }
            lucide.createIcons();
        };

        // ==========================================
        // âš™ï¸ è¦–åœ–ï¼šå¾Œå° (Admin)
        // ==========================================
        function renderAdmin(container) {
            container.innerHTML = `
                <div class="bg-white text-gray-800 p-6 rounded-3xl h-full shadow-xl flex flex-col animate-fade-in">
                    <h2 class="text-2xl font-bold text-red-900 mb-6 flex items-center gap-2 border-b pb-4">
                        <i data-lucide="settings"></i> ç®¡ç†è€…ä¸­æ§å°
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-bold text-gray-600 mb-4 flex items-center gap-2"><i data-lucide="toggle-left"></i> æ´»å‹•ç‹€æ…‹æ§åˆ¶</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="updateStatus('idle')" class="p-4 rounded-xl border-2 border-yellow-200 bg-yellow-50 hover:bg-yellow-100 flex flex-col items-center gap-2 transition">
                                    <i data-lucide="stop-circle" class="text-yellow-600"></i> 
                                    <span class="font-bold text-yellow-800">æº–å‚™ä¸­</span>
                                </button>
                                <button onclick="updateStatus('active')" class="p-4 rounded-xl border-2 border-green-200 bg-green-50 hover:bg-green-100 flex flex-col items-center gap-2 transition">
                                    <i data-lucide="play-circle" class="text-green-600"></i> 
                                    <span class="font-bold text-green-800">é€²è¡Œä¸­</span>
                                </button>
                                <button onclick="updateStatus('ended')" class="p-4 rounded-xl border-2 border-red-200 bg-red-50 hover:bg-red-100 flex flex-col items-center gap-2 transition">
                                    <i data-lucide="x-circle" class="text-red-600"></i> 
                                    <span class="font-bold text-red-800">å·²çµæŸ</span>
                                </button>
                            </div>
                            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-xs text-gray-500">
                                ç•¶å‰: <strong class="text-blue-600 uppercase">${state.gameStatus}</strong> (é»æ“ŠæŒ‰éˆ•å¾Œéœ€è¼¸å…¥ admin)
                            </div>
                        </div>

                        <div>
                            <h3 class="font-bold text-gray-600 mb-4 flex items-center gap-2"><i data-lucide="database"></i> æ•¸æ“šç®¡ç†</h3>
                            <div class="space-y-3">
                                <button onclick="clearData()" class="w-full border border-red-200 text-red-600 py-3 rounded-xl hover:bg-red-50 font-bold flex items-center justify-center gap-2 transition">
                                    <i data-lucide="trash-2"></i> æ¸…ç©ºæ‰€æœ‰æ•¸æ“š (Clear DB)
                                </button>
                                <button onclick="window.open('${GAS_API_URL.replace('exec', 'echo')}', '_blank')" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 font-bold flex items-center justify-center gap-2 transition">
                                    <i data-lucide="external-link"></i> é–‹å•Ÿ Google Sheet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.updateStatus = function(status) {
            const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ (é è¨­: admin)");
            if (!pwd) return;

            // Optimistic UI Update
            const oldStatus = state.gameStatus;
            state.gameStatus = status;
            updateStatusUI();

            fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'update_status',
                    status: status,
                    password: pwd
                })
            }).then(() => {
                // no-cors ç„¡æ³•ç¢ºèªæˆåŠŸï¼Œå‡è¨­æˆåŠŸ
                console.log('Status update sent');
            }).catch(() => {
                state.gameStatus = oldStatus;
                alert('é€£ç·šå¤±æ•—');
            });
        };

        window.clearData = function() {
            const pwd = prompt("âš ï¸ è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºæ‰€æœ‰åƒè³½è€…æ•¸æ“šï¼\nè«‹è¼¸å…¥å¯†ç¢¼ç¢ºèªï¼š");
            if (!pwd) return;

            fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'clear_data', password: pwd })
            }).then(() => {
                state.participants = [];
                alert('æ¸…ç©ºæŒ‡ä»¤å·²ç™¼é€');
            });
        };
    </script>
</body>
</html>